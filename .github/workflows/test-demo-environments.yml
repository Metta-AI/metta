name: Test Demo Environments

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'mettagrid/demos/**'
      - 'mettagrid/src/**'
      - 'mettagrid/pyproject.toml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'mettagrid/demos/**'
      - 'mettagrid/src/**'
      - 'mettagrid/pyproject.toml'
  workflow_dispatch:

jobs:
  test-demo-environments:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup uv
      uses: ./.github/actions/setup-uv
      with:
        install-mode: "no-mettagrid"
    
    - name: Install mettagrid
      run: |
        uv pip install --no-build-isolation --no-deps -e ./mettagrid
    
    - name: Test gym
      run: |
        cd mettagrid/demos
        echo "Testing gym_demo..."
        timeout 120 uv run python gym_demo.py || exit_code=$?
        if [ $exit_code -eq 124 ]; then
          echo "✅ gym_demo ran successfully for 120 seconds"
        elif [ $exit_code -eq 0 ]; then
          echo "✅ gym_demo completed successfully"
        else
          echo "❌ gym_demo failed with exit code $exit_code"
          exit 1
        fi
    
    - name: Test pettingzoo
      run: |
        cd mettagrid/demos
        echo "Testing pettingzoo_demo..."
        timeout 120 uv run python pettingzoo_demo.py || exit_code=$?
        if [ $exit_code -eq 124 ]; then
          echo "✅ pettingzoo_demo ran successfully for 120 seconds"
        elif [ $exit_code -eq 0 ]; then
          echo "✅ pettingzoo_demo completed successfully"
        else
          echo "❌ pettingzoo_demo failed with exit code $exit_code"
          exit 1
        fi
    
    - name: Test puffer
      run: |
        cd mettagrid/demos
        echo "Testing puffer_demo..."
        timeout 120 uv run python puffer_demo.py || exit_code=$?
        if [ $exit_code -eq 124 ]; then
          echo "✅ puffer_demo ran successfully for 120 seconds"
        elif [ $exit_code -eq 0 ]; then
          echo "✅ puffer_demo completed successfully"
        else
          echo "❌ puffer_demo failed with exit code $exit_code"
          exit 1
        fi
    
    - name: Test all demos with test script
      run: |
        cd mettagrid/demos
        uv run python test_demos.py