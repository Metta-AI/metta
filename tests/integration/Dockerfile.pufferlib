# Dockerfile for PufferLib integration testing
# This provides a clean, reproducible environment for testing Metta with PufferLib

FROM python:3.11.7-slim as base

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    curl \
    # Graphics libraries needed by some environments
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender1 \
    libgomp1 \
    # Additional build tools
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /workspace

# Create test user (non-root)
RUN useradd -m -s /bin/bash metta && \
    chown -R metta:metta /workspace

# Switch to test user
USER metta

# Set up Python environment
ENV PATH="/home/metta/.local/bin:${PATH}"
ENV PYTHONUNBUFFERED=1

# Copy test scripts
COPY --chown=metta:metta tests/integration/test_pufferlib_fresh_install.sh /workspace/
COPY --chown=metta:metta tests/integration/test_pufferlib_integration.py /workspace/

# Make scripts executable
RUN chmod +x /workspace/test_pufferlib_fresh_install.sh

# Default command runs both shell and Python tests
CMD ["/bin/bash", "-c", "\
    echo '=== Running PufferLib Integration Tests ===' && \
    echo && \
    echo '1. Shell-based fresh install test:' && \
    /workspace/test_pufferlib_fresh_install.sh stable && \
    echo && \
    echo '2. Python-based integration tests:' && \
    cd /workspace/metta && \
    python -m pytest tests/integration/test_pufferlib_integration.py -v \
"]

# Build stage for testing with source
FROM base as test

# Copy Metta source code
COPY --chown=metta:metta . /workspace/metta/

# Set working directory to metta root
WORKDIR /workspace/metta

# Install dependencies
RUN pip install --user --upgrade pip setuptools wheel && \
    pip install --user pytest numpy torch gymnasium omegaconf pydantic

# Run tests by default
ENTRYPOINT ["/bin/bash", "-c"]
CMD ["cd /workspace && ./test_pufferlib_fresh_install.sh both"]