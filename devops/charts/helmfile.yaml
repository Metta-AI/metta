repositories:
  - name: external-dns
    url: https://kubernetes-sigs.github.io/external-dns/
  - name: cert-manager
    url: https://charts.jetstack.io
  - name: ingress-nginx
    url: https://kubernetes.github.io/ingress-nginx
  - name: metrics-server
    url: https://kubernetes-sigs.github.io/metrics-server/
  - name: skypilot
    url: https://helm.skypilot.co
  - name: datadog
    url: https://helm.datadoghq.com

templates:
  cronjob: &cronjob_template
    chart: ./cronjob
    version: 0.1.0
    namespace: monitoring

releases:
  ########## System configurations ##########
  - name: system
    chart: ./system
    version: 0.1.0
    namespace: kube-system
    values:
      - nodePools:
          jobs:
            enabled: true

  ########## Core infrastructure ##########
  - name: external-dns
    chart: external-dns/external-dns
    version: 1.17.0
    namespace: external-dns
    values:
      - env:
          - name: AWS_DEFAULT_REGION
            value: us-east-1
        serviceAccount:
          annotations:
            # created by terraform
            eks.amazonaws.com/role-arn: arn:aws:iam::751442549699:role/external-dns

  - name: cert-manager
    chart: ./cert-manager
    version: v1.18.1
    namespace: cert-manager
    values:
      - installCRDs: true

  - name: ingress-nginx
    chart: ingress-nginx/ingress-nginx
    version: 4.11.3
    namespace: ingress-nginx
    values:
      - ./helm.values/ingress-nginx-values.yaml

  - name: metrics-server
    chart: metrics-server/metrics-server
    version: 3.12.2
    namespace: metrics-server

  - name: prometheus
    chart: oci://ghcr.io/prometheus-community/charts/kube-prometheus-stack
    version: 80.2.0
    disableValidation: true
    namespace: monitoring
    values:
      - ./helm.values/prometheus-values.yaml

  - name: datadog
    chart: datadog/datadog
    version: 3.75.0
    namespace: monitoring
    values:
      - ./helm.values/datadog-values.yaml

  ########## Skypilot ##########
  - name: skypilot
    chart: skypilot/skypilot
    version: 0.11.1
    namespace: skypilot
    values:
      - ./helm.values/skypilot-values.yaml

  # Uncomment the following section if you want to test a new skypilot release or configuration.
  # Deploy with `helmfile apply -i -l name=skypilot-beta`.
  #
  # You'll need to copy some secrets to the new namespace:
  #
  # for s in lambda-ai-credentials aws-credentials softmax-infra-oauth; do
  #   kubectl get secret $s --namespace=skypilot -o yaml | sed 's/namespace: .*/namespace: skypilot-beta/' | kubectl apply -f -
  # done

  # - name: skypilot-beta
  #   chart: skypilot/skypilot
  #   version: 0.0.0
  #   namespace: skypilot-beta
  #   values:
  #     - ./helm.values/skypilot-values.yaml
  #     - apiService:
  #         image: berkeleyskypilot/skypilot:0.10.3
  #       rbac:
  #         manageRbacPolicies: false
  #         manageSystemComponents: false
  #       ingress:
  #         host: skypilot-api-beta.softmax-research.net

  ########## Softmax apps ##########
  - name: orchestrator
    chart: ./orchestrator
    version: 0.1.0
    namespace: observatory
    hooks:
      - events: ["presync"]
        command: "kubectl"
        args: ["create", "namespace", "orchestrator", "--dry-run=client"]

  - name: home
    chart: ./home
    version: 0.1.0
    namespace: home
    hooks:
      - events: ["presync"]
        command: "kubectl"
        args: ["create", "namespace", "home", "--dry-run=client"]
  # Note: Observatory is deployed automatically by Github Actions.

  ########## Cronjobs ##########
  # Shared cronjob template for all periodic tasks
  # All cronjobs get broad read-only cluster permissions (see cronjob/templates/rbac.yaml).
  # We value simplicity over fine-grained security - some cronjobs get more access than needed.
  #
  # NOTE: Cronjobs are deployed automatically by GitHub Actions workflows, not manually via helmfile.
  # The workflows override the image.tag values below with specific SHA-tagged images.
  # The tag values here are only used if someone manually runs: helmfile apply -l name=<cronjob>
  #
  # To add a new cronjob:
  #   1. Create Dockerfile.{name} in devops/charts/cronjob/
  #   2. Add release entry below using <<: *cronjob_template
  #   3. Create GitHub workflow in .github/workflows/deploy-{name}-cronjob.yml
  #      - Set image_name: metta-cronjobs
  #      - Set suffix: -{name} to create tags like latest-{name}

  - name: pr-similarity-cache-cronjob
    <<: *cronjob_template
    values:
      - schedule: "0 0 * * *" # Daily at midnight
      - image:
          tag: latest-pr-similarity # Workflow overrides with sha-abc123-pr-similarity
      - datadog:
          service: pr-similarity-cache-refresh

  - name: metrics-collector-cronjob
    <<: *cronjob_template
    values:
      - schedule: "*/15 * * * *" # Every 15 minutes
      - image:
          tag: latest-metrics-collector # Workflow overrides with sha-abc123-metrics-collector
      - datadog:
          service: metrics-collector

  # Dev cronjob deployments (see devops/charts/CRONJOB_DEV_WORKFLOW.md for instructions)
  # Uncomment the release you want to deploy for dev testing:
  #
  # - name: pr-similarity-cache-cronjob-dev
  #   <<: *cronjob_template
  #   values:
  #     - schedule: "*/5 * * * *"  # Every 5 minutes for testing
  #     - datadog:
  #         service: pr-similarity-cache-refresh-dev
  #         env: dev
# Helpful commands:
#   Deploy cronjob definition: cd devops/charts && helmfile -l name=<release-name> apply
#   Inspect cronjob definition: kubectl get cronjobs -n monitoring
#   Trigger a run of cronjob off-schedule: kubectl -n monitoring create job <custom-name> --from=cronjob/<release-name>-cronjob
#   Inspect runs/logs: kubectl get jobs -n monitoring && kubectl logs -n monitoring job/<job-name>
