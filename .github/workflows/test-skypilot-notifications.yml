name: "Test SkyPilot Notifications"

on:
  push:
    branches:
      - robb/0911-test-notifications

  workflow_dispatch:
    inputs:
      scenario:
        description: "Scenario to test (leave empty for random)"
        required: false
        type: choice
        options:
          - "" # Random
          - job_completed
          - job_failed_137
          - heartbeat_timeout
          - nccl_tests_failed
          - rapid_restarts
          - max_runtime_reached
jobs:
  test-notifications:
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      contents: read

    steps:
      - name: Checkout PR branch (default behavior)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch main branch HEAD
        run: |
          git fetch origin main
          MAIN_SHA=$(git rev-parse origin/main)
          echo "Main branch HEAD SHA: $MAIN_SHA"
          echo "main_sha=$MAIN_SHA" >> $GITHUB_OUTPUT
        id: get_main_sha

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          install-mode: minimal
          extra-dependencies: |
            requests>=2.31.0
            dataclasses

      - name: Install required local packages in editable mode
        run: |
          cd common
          uv pip install -e .
          cd ..
          cd gitta
          uv pip install -e .

      - name: Run notification tests
        env:
          PYTHONPATH: .
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_TEST_HOOK }}
          GITHUB_PAT: ${{ secrets.METTA_STATUS_PAT }}
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          TEST_SCENARIO: ${{ inputs.scenario }}
        run: |
          python .github/scripts/test_notifications.py

      - name: Summary
        if: always()
        run: |
          cat /tmp/test_summary.md >> $GITHUB_STEP_SUMMARY
