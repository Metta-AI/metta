schedule: "0 0 * * *"  # Run once daily at midnight

image:
  registry: 751442549699.dkr.ecr.us-east-1.amazonaws.com
  name: pr-similarity-cache
  pullPolicy: Always
  tag: "latest"

# Command to refresh PR similarity cache
# This bash script ensures the container has the latest code from main branch
# and uses uv run --no-sync to avoid installing unnecessary dependencies
command:
  - /bin/bash
  - -c
  - |
    set -e
    cd /workspace/metta
    git config --local --unset http.https://github.com/.extraheader 2>/dev/null || true
    git remote set-url origin https://github.com/Metta-AI/metta.git
    git fetch --unshallow origin main 2>/dev/null || git fetch origin main
    git checkout -f origin/main
    uv pip install numpy google-genai boto3
    PYTHONPATH=/workspace/metta uv run --no-sync python mcp_servers/pr_similarity/build_cache.py --download-from-s3

serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::751442549699:role/pr-similarity-cache-cronjob

resources:
  requests:
    cpu: 100m
    memory: 2Gi
  limits:
    cpu: 500m
    memory: 2Gi

# Datadog metric tagging
datadog:
  env: "production"
  service: "pr-similarity-cache-refresh"
  site: "datadoghq.com"

# CronJob configuration
successfulJobsHistoryLimit: 3
failedJobsHistoryLimit: 3
concurrencyPolicy: Forbid  # Don't allow concurrent executions
restartPolicy: OnFailure
backoffLimit: 3
