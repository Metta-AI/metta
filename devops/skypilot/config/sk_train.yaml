resources:
  cloud: aws
  any_of:
    - region: us-east-1
      use_spot: true
      accelerators: "L4:1"
    - region: us-east-1
      use_spot: true
      accelerators: "A10G:1"
    - region: us-east-1
      accelerators: "L4:1"
    - region: us-east-1
      accelerators: "A10G:1"
    - region: us-west-2
      use_spot: true
      accelerators: "L4:1"
    - region: us-west-2
      use_spot: true
      accelerators: "A10G:1"
    - region: us-west-2
      accelerators: "L4:1"
    - region: us-west-2
      accelerators: "A10G:1"
  cpus: 8+
  image_id: docker:metta:latest
  job_recovery:
    strategy: EAGER_NEXT_REGION
    max_restarts_on_errors: 1000

setup: |
  set -xe
  echo "[SETUP] Starting setup phase..."

  if [ ! -d /workspace/metta/.git ]; then
    echo "[SETUP] Cloning repo..."
    git clone https://github.com/Metta-AI/metta.git /workspace/metta

  else
    echo "[SETUP] Repo already present, skipping clone."
  fi

  cd /workspace/metta

  echo "[SETUP] Fetching latest from origin..."
  git fetch --depth=1000 origin "$METTA_GIT_REF" || git fetch origin

  echo "[SETUP] Checking out ref: $METTA_GIT_REF"
  git checkout "$METTA_GIT_REF"

  echo "[SETUP] Current commit:"
  git rev-parse HEAD

  echo "[SETUP] Syncing dependencies with uv..."
  if ! uv sync; then
    echo "[SETUP] ❌ uv sync failed." >&2
    exit 1
  fi

  echo "[SETUP] Creating wandb directory: $WANDB_DIR"
  mkdir -p "$WANDB_DIR"

  echo "[SETUP] Current directory: $(pwd)"
  echo "[SETUP] Directory contents:"
  ls -lh
  echo "[SETUP] Setup complete."

run: |
  set -xe
  START_TIME=$(date)

  echo "[RUN] Starting run phase..."
  cd /workspace/metta
  source ./devops/setup.env

  echo "[RUN] METTA_RUN_ID: $METTA_RUN_ID"
  echo "[RUN] SKYPILOT_TASK_ID: $SKYPILOT_TASK_ID"
  echo "[RUN] Running latency script..."

  echo "[RUN] Python version:"
  python --version || { echo "❌ Python not found" >&2; exit 1; }

  if [ -f common/src/metta/common/util/skypilot_latency.py ]; then
    echo "[RUN] Found latency script, running..."
    python common/src/metta/common/util/skypilot_latency.py 2>&1 | tee latency_output.log
    LAT_EXIT=$?
    echo "[RUN] Latency script exit code: $LAT_EXIT"
  else
    echo "[RUN] ❌ Latency script not found at common/src/metta/common/util/skypilot_latency.py" >&2
    echo "[RUN] Working directory: $(pwd)"
    echo "[RUN] Full tree:"
    find . | grep skypilot_latency
    exit 1
  fi

  export NUM_GPUS=$SKYPILOT_NUM_GPUS_PER_NODE
  export NUM_NODES=$SKYPILOT_NUM_NODES
  export MASTER_ADDR=$(echo "$SKYPILOT_NODE_IPS" | head -n1)
  export MASTER_PORT=8008
  export NODE_INDEX=$SKYPILOT_NODE_RANK
  export NCCL_SHM_DISABLE=1

  echo "[RUN] Running training script..."
  ./devops/$METTA_CMD.sh \
    run=$METTA_RUN_ID \
    $METTA_CMD_ARGS
  TRAIN_EXIT=$?
  echo "[RUN] Training script exit code: $TRAIN_EXIT"

  echo "[RUN] Job complete."
  END_TIME=$(date)
  echo "[RUN] Started at: $START_TIME"
  echo "[RUN] Ended at:   $END_TIME"
  exit $TRAIN_EXIT

file_mounts:
  ~/.netrc: ~/.netrc
  ~/.metta: ~/.metta
  /mnt/s3/softmax-public:
    source: s3://softmax-public
    mode: MOUNT_CACHED
  /mnt/s3/train_dir:
    name: softmax-train-dir
    store: s3
    mode: MOUNT_CACHED

envs:
  METTA_RUN_ID: ""
  METTA_CMD: train
  METTA_CMD_ARGS: ""
  METTA_GIT_REF: main
  WANDB_DIR: ./wandb
  DATA_DIR: /mnt/s3/train_dir
  SKYPILOT_DOCKER_USERNAME: ""
  SKYPILOT_DOCKER_PASSWORD: ""
  SKYPILOT_DOCKER_SERVER: 751442549699.dkr.ecr.us-east-1.amazonaws.com
