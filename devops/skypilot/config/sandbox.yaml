resources:
  cloud: aws
  region: us-east-1
  accelerators: "A10G:1"
  cpus: 8+
  image_id: docker:metta:latest

file_mounts:
  /mnt/s3/softmax-public:
    source: s3://softmax-public
    mode: MOUNT_CACHED
  /mnt/s3/train_dir:
    source: s3://softmax-train-dir
    mode: MOUNT_CACHED


setup: |
  set -e
  echo "[SETUP] Starting setup..."

  cd /workspace/metta

  git fetch --depth=1000 origin "$METTA_GIT_REF" || git fetch origin
  git checkout "$METTA_GIT_REF"
  echo "[SETUP] Checked out: $(git rev-parse HEAD)"

  bash ./devops/skypilot/config/setup-common.sh
  bash ./devops/skypilot/config/gpu-troubleshoot.sh || true

  echo "[SETUP] Setup complete."

run: |
  set -e
  echo "[RUN] Starting run..."

  exec bash

envs:
  METTA_GIT_REF: main
  WANDB_DIR: ./wandb

  # configured by launch script based on local credentials
  WANDB_PASSWORD: ""
  OBSERVATORY_TOKEN: ""

  # username and password are acquired automatically by our skypilot-api-server patch, see skypilot-chart/files/ecr.patch
  SKYPILOT_DOCKER_USERNAME: ""
  SKYPILOT_DOCKER_PASSWORD: ""
  SKYPILOT_DOCKER_SERVER: 751442549699.dkr.ecr.us-east-1.amazonaws.com
