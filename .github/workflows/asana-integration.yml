name: Asana Integration

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "The branch to test the workflow on"
        default: "main"
        required: true
      pr_number:
        description: "The pull request number to test the workflow on"
        required: true

jobs:
  asana_integration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Get PR details
        id: pr-details
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_TITLE=$(gh pr view ${{ github.event.inputs.pr_number }} --json title --jq '.title')
          PR_BODY=$(gh pr view ${{ github.event.inputs.pr_number }} --json body --jq '.body')
          PR_URL=$(gh pr view ${{ github.event.inputs.pr_number }} --json url --jq '.url')

          # Clean the data - remove problematic characters and normalize
          PR_TITLE=$(echo "$PR_TITLE" | tr -d '\r' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          PR_BODY=$(echo "$PR_BODY" | tr -d '\r' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          PR_URL=$(echo "$PR_URL" | tr -d '\r' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

          # Escape and write outputs safely using multiline syntax
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "url<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_URL" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Ensure Asana Task
        id: ensure-asana-task
        uses: ./.github/actions/asana/ensure-task
        with:
          title: ${{ steps.pr-details.outputs.title }}
          description: ${{ steps.pr-details.outputs.body }}
          project_id: ${{ env.ASANA_PROJECT_GID }}
          asana_token: ${{ secrets.ASANA_GITHUB_INTEGRATION_SECRET }}
          github_url: ${{ steps.pr-details.outputs.url }}
          github_url_field_id: ${{ env.ASANA_GITHUB_URL_FIELD_GID }}

      - name: Update PR Description
        uses: ./.github/actions/asana/update-pr-description
        with:
          pr_number: ${{ github.event.inputs.pr_number }}
          repo: ${{ github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}
          task_url: ${{ steps.ensure-asana-task.outputs.task_url }}
