# Maps and Curriculums in Metta: Quick Reference

This document provides a quick overview of how maps, curriculums, and configurations work together in Metta.

## System Overview

```
┌─────────────────────┐
│ Training Pipeline   │
└──────────┬──────────┘
           │
    ┌──────▼──────┐
    │ Curriculum  │ ← Selects tasks based on strategy
    └──────┬──────┘
           │
    ┌──────▼──────┐
    │    Task     │ ← Contains environment config
    └──────┬──────┘
           │
    ┌──────▼──────┐
    │ Environment │ ← Uses map_builder to create world
    └──────┬──────┘
           │
    ┌──────▼──────┐
    │     Map     │ ← Generated by scene system
    └─────────────┘
```

## Quick Start Examples

### 1. Simple Fixed Curriculum with Random Maps

```yaml
# configs/my_experiment.yaml
defaults:
  - common
  - agent: fast
  - trainer: trainer
  - _self_

trainer:
  curriculum: /env/mettagrid/curriculum/navigation/simple
  total_timesteps: 1_000_000

---
# configs/env/mettagrid/curriculum/navigation/simple.yaml
_target_: metta.mettagrid.curriculum.random.RandomCurriculum

tasks:
  /env/mettagrid/navigation/easy: 1
  /env/mettagrid/navigation/hard: 1

env_overrides:
  game:
    num_agents: 8

---
# configs/env/mettagrid/navigation/easy.yaml
defaults:
  - /env/mettagrid/mettagrid@
  - _self_

game:
  max_steps: 500
  map_builder:
    _target_: metta.map.mapgen.MapGen
    width: 30
    height: 30
    root:
      type: metta.map.scenes.random.Random
      params:
        agents: 8
        objects:
          wall: 5
          altar: 1
```

### 2. Bucketed Curriculum with Varied Maps

```yaml
# Curriculum that varies both map size and object density
_target_: metta.mettagrid.curriculum.bucketed.BucketedCurriculum

env_cfg_template: /env/mettagrid/navigation/base

buckets:
  # Vary map dimensions
  game.map_builder.width:
    range: [20, 60]
    bins: 3  # 20-33, 33-47, 47-60

  game.map_builder.height:
    range: [20, 60]
    bins: 3

  # Vary map content
  game.map_builder.root.params.objects.wall:
    range: [5, 30]
    bins: 3

  # Use different map patterns
  game.map_builder.root.scene:
    values:
      - /wfc/simple.yaml
      - /wfc/dungeons.yaml
      - /wfc/mazelike1.yaml
```

### 3. Progressive Curriculum with Increasing Complexity

```yaml
_target_: metta.mettagrid.curriculum.progressive.ProgressiveMultiTaskCurriculum

tasks:
  # Start with empty maps
  /env/mettagrid/navigation/empty: 1

  # Add simple obstacles
  /env/mettagrid/navigation/obstacles: 1

  # Introduce mazes
  /env/mettagrid/navigation/maze: 1

  # Complex dungeons
  /env/mettagrid/navigation/dungeon: 1

performance_threshold: 0.7
progression_mode: "perf"
```

### 4. Learning Progress with Adaptive Selection

```yaml
_target_: metta.mettagrid.curriculum.learning_progress.LearningProgressCurriculum

tasks:
  /env/mettagrid/maps/terrain1: 1
  /env/mettagrid/maps/terrain2: 1
  /env/mettagrid/maps/terrain3: 1
  /env/mettagrid/maps/terrain4: 1

# Focuses on tasks where agent is improving fastest
num_active_tasks: 2
ema_timescale: 0.001
```

## Key Concepts

### Maps
- **Scene System**: Hierarchical, composable map generation
- **Procedural Generation**: Use distributions for variety
- **External Scenes**: Reusable patterns in YAML files
- **Grid Output**: 2D numpy arrays with cell types

### Curriculums
- **Task Selection**: Different strategies for choosing training tasks
- **Performance Tracking**: Adaptive curriculums respond to agent progress
- **Bucketing**: Automatic parameter sweep generation
- **Scheduling**: Automated progression through task difficulties

### Configuration
- **Hydra Composition**: Combine multiple configs hierarchically
- **Parameter Overrides**: Change any value from command line
- **Interpolation**: Reference other config values dynamically
- **Sampling**: Randomize parameters during training

## Common Patterns

### Pattern 1: Vary Single Parameter
```yaml
buckets:
  game.agent.view_dist:
    range: [3, 11]
    bins: 4
```

### Pattern 2: Correlated Parameters
```yaml
buckets:
  game.map_builder.width:
    values: [30, 60, 90]
  game.map_builder.height:
    values: [30, 60, 90]
  game.max_steps:
    values: [500, 1000, 1500]
```

### Pattern 3: Map Type Selection
```yaml
game.map_builder.root.content:
  - scene: /wfc/dungeons.yaml
    weight: 70
  - scene:
      type: metta.map.scenes.maze.Maze
    weight: 30
```

## Command Line Usage

```bash
# Basic training with curriculum
python train.py trainer.curriculum=/env/mettagrid/curriculum/navigation/bucketed

# Override curriculum parameters
python train.py \
  trainer.curriculum=/env/mettagrid/curriculum/navigation/bucketed \
  trainer.curriculum.buckets.game.num_agents.values='[4,8,16]'

# Use different map for evaluation
python train.py \
  trainer.curriculum=/env/mettagrid/curriculum/navigation/learning_progress \
  sim.env.game.map_builder.root.scene=/wfc/mazelike1.yaml
```

## Performance Considerations

1. **Bucketed Curriculums**: Generate all combinations upfront (can be memory intensive)
2. **Map Generation**: Complex scenes take longer to generate
3. **Agent Count**: More agents = larger batch size requirements
4. **View Distance**: Affects observation size and compute

## Debugging Tips

1. **Visualize Maps**: Use `./tools/map/gen.py` to preview maps
2. **Check Task Distribution**: Monitor curriculum statistics in logs
3. **Test Configs**: Use `--cfg job` to see composed configuration
4. **Start Simple**: Begin with RandomCurriculum and simple maps

## Further Reading

- [Map Generation README](../metta/map/README.md) - Detailed map system documentation
- [Curriculum README](../metta/mettagrid/src/metta/mettagrid/curriculum/README.md) - Complete curriculum guide
- [Configuration Guide](../configs/README.md) - Hydra configuration details
