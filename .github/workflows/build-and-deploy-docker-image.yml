name: "Build and Deploy Docker Image (Reusable)"

on:
  workflow_call:
    inputs:
      image_name:
        description: "Name of the Docker image (e.g., softmax-dashboard)"
        required: true
        type: string
      dockerfile:
        description: "Path to Dockerfile (e.g., ./devops/datadog/Dockerfile.collectors)"
        required: true
        type: string
      helm_release:
        description: "Helm release name (e.g., dashboard-cronjob)"
        required: false
        type: string
        default: ""
      helm_namespace:
        description: "Kubernetes namespace for deployment (e.g., monitoring)"
        required: false
        type: string
        default: ""
      helm_chart:
        description: "Path to Helm chart (e.g., ./devops/charts/dashboard-cronjob)"
        required: false
        type: string
        default: ""
      deploy_enabled:
        description: "Enable helm deployment step"
        required: false
        type: boolean
        default: true

jobs:
  build-and-push-image:
    runs-on: ubuntu-4core
    timeout-minutes: 20
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Build Docker image
        id: build-image
        uses: ./.github/actions/docker-build
        with:
          image_name: ${{ inputs.image_name }}
          dockerfile: ${{ inputs.dockerfile }}
          aws_role: ${{ vars.AWS_ROLE }}

      - name: Deploy helm chart
        if: |
          github.ref == 'refs/heads/main' &&
          inputs.deploy_enabled &&
          inputs.helm_release != '' &&
          inputs.helm_namespace != '' &&
          inputs.helm_chart != ''
        run: |
          aws eks update-kubeconfig --name main --region us-east-1
          helm upgrade -n ${{ inputs.helm_namespace }} ${{ inputs.helm_release }} ${{ inputs.helm_chart }} \
            --set image.tag=${{ steps.build-image.outputs.tag }}
