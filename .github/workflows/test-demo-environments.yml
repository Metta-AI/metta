name: Test Demo Environments

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'mettagrid/demos/**'
      - 'mettagrid/src/**'
      - 'mettagrid/pyproject.toml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'mettagrid/demos/**'
      - 'mettagrid/src/**'
      - 'mettagrid/pyproject.toml'
  workflow_dispatch:

jobs:
  test-demo-environments:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    strategy:
      fail-fast: false
      matrix:
        demo: [gym_demo, pettingzoo_demo, puffer_demo]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup uv
      uses: ./.github/actions/setup-uv
      with:
        install-mode: "no-mettagrid"
    
    - name: Install mettagrid
      run: |
        uv pip install --no-build-isolation --no-deps -e ./mettagrid
    
    - name: Test ${{ matrix.demo }}
      run: |
        cd mettagrid/demos
        echo "Testing ${{ matrix.demo }}..."
        timeout 30 uv run python ${{ matrix.demo }}.py
        exit_code=$?
        if [ $exit_code -eq 124 ]; then
          echo "✅ ${{ matrix.demo }} ran successfully for 30 seconds"
        elif [ $exit_code -eq 0 ]; then
          echo "✅ ${{ matrix.demo }} completed successfully"
        else
          echo "❌ ${{ matrix.demo }} failed with exit code $exit_code"
          exit 1
        fi
    
    - name: Test all demos with test script
      run: |
        cd mettagrid/demos
        uv run python test_demos.py