# Dashboard Templates

This directory contains **generated JSON dashboard files** that are uploaded to Datadog.

## Dashboard Source Workflow

### Primary Workflow: Jsonnet → JSON → Datadog

1. **Source Files**: Write dashboards in Jsonnet (reusable, composable)
   - Location: `devops/datadog/dashboards/sources/*.jsonnet`
   - Components: `devops/datadog/dashboards/components/*.libsonnet`

2. **Build**: Compile Jsonnet to JSON
   ```bash
   # Build a specific dashboard
   jsonnet dashboards/sources/asana.jsonnet > dashboards/templates/asana.json

   # Or use the CLI
   metta datadog dashboard build asana
   ```

3. **Deploy**: Push JSON to Datadog
   ```bash
   # Push to Datadog
   python scripts/push_dashboard.py dashboards/templates/asana.json

   # Or use the CLI
   metta datadog dashboard push asana
   ```

**Important**: JSON files in `templates/` are **build artifacts** and should not be committed to git (they're in `.gitignore`).

---

## Current Dashboard Sources

### ✅ Jsonnet Sources (Preferred Workflow)
These dashboards are built from `.jsonnet` source files:

- `asana.json` ← `dashboards/sources/asana.jsonnet` + `dashboards/components/asana.libsonnet`
- `ec2.json` ← `dashboards/sources/ec2.jsonnet` + `dashboards/components/ec2.libsonnet`
- `github_cicd.json` ← `dashboards/sources/github_cicd.jsonnet` + `dashboards/components/github.libsonnet`
- `kubernetes.json` ← `dashboards/sources/kubernetes.jsonnet` + `dashboards/components/infrastructure.libsonnet`
- `skypilot_jobs.json` ← `dashboards/sources/skypilot_jobs.jsonnet` + `dashboards/components/skypilot.libsonnet`
- `wandb.json` ← `dashboards/sources/wandb.jsonnet` + `dashboards/components/wandb.libsonnet`

**Build these dashboards**:
```bash
# Build a specific dashboard
jsonnet dashboards/sources/github_cicd.jsonnet > dashboards/templates/github_cicd.json

# Build all dashboards
for f in dashboards/sources/*.jsonnet; do
  name=$(basename "$f" .jsonnet)
  jsonnet "$f" > "dashboards/templates/${name}.json"
done
```

### 🔧 Python-Generated Dashboards
These dashboards are generated by Python scripts for complex visualizations (Vega-Lite, custom grids):

- `system_health_rollup.json` ← `scripts/generate_health_grid.py` (7×7 FoM grid, 65 widgets)
- `system_health_rollup_wildcard.json` ← `scripts/generate_wildcard_fom_grid.py` (Vega-Lite heatmap)

**Generate these dashboards**:
```bash
# Generate the health grid dashboard
uv run python scripts/generate_health_grid.py

# Generate the Vega-Lite wildcard version
uv run python scripts/generate_wildcard_fom_grid.py
```

### ⚠️ Legacy Hand-Crafted JSON (Needs Migration)
These dashboards are currently hand-crafted JSON files tracked in git:

- `policy_evaluator.json` - **TODO**: Convert to jsonnet or determine if still needed

**All other dashboards have been migrated to jsonnet** ✅

---

## Creating a New Dashboard

### Option 1: Jsonnet (Recommended)

1. Create a new `.jsonnet` file in `dashboards/sources/`:
   ```jsonnet
   // dashboards/sources/my_dashboard.jsonnet
   local widgets = import '../components/infrastructure.libsonnet';

   {
     title: 'My Dashboard',
     widgets: [
       widgets.timeseries(
         title='CPU Usage',
         query='avg:system.cpu.user{*}'
       ),
     ],
   }
   ```

2. Build the JSON:
   ```bash
   jsonnet dashboards/sources/my_dashboard.jsonnet > dashboards/templates/my_dashboard.json
   ```

3. Push to Datadog:
   ```bash
   python scripts/push_dashboard.py dashboards/templates/my_dashboard.json
   ```

### Option 2: Python Generation

For complex visualizations (like grids, custom Vega-Lite):

1. Create a script in `scripts/generate_*.py`
2. Generate JSON to `dashboards/templates/`
3. Push to Datadog

### Option 3: Export from Datadog UI

For quick prototyping:

1. Create dashboard in Datadog UI
2. Export using `scripts/export_dashboard.py <dashboard-id>`
3. Save to `dashboards/templates/` for reference
4. **Then** convert to Jsonnet for version control

---

## File Organization

```
devops/datadog/
├── dashboards/                    # Dashboard files (grouped)
│   ├── sources/                  # Source files (.jsonnet)
│   │   ├── asana.jsonnet
│   │   ├── ec2.jsonnet
│   │   ├── github_cicd.jsonnet
│   │   ├── kubernetes.jsonnet
│   │   ├── skypilot_jobs.jsonnet
│   │   └── wandb.jsonnet
│   │
│   ├── components/               # Reusable widget libraries (.libsonnet)
│   │   ├── asana.libsonnet
│   │   ├── ci.libsonnet
│   │   ├── ec2.libsonnet
│   │   ├── github.libsonnet
│   │   ├── infrastructure.libsonnet
│   │   ├── skypilot.libsonnet
│   │   └── wandb.libsonnet
│   │
│   ├── lib/                      # Base Jsonnet primitives
│   │
│   └── templates/                # Generated JSON (gitignored build artifacts)
│       ├── asana.json           # ← Built from sources/asana.jsonnet
│       ├── ec2.json             # ← Built from sources/ec2.jsonnet
│       ├── github_cicd.json     # ← Built from sources/github_cicd.jsonnet
│       ├── *.json               # ← Other generated files
│       └── README.md            # ← This file
│
└── scripts/                      # Build and deployment scripts
    ├── push_dashboard.py
    ├── fetch_dashboards.py
    ├── generate_health_grid.py
    └── generate_wildcard_fom_grid.py
```

---

## Why Jsonnet?

**Benefits**:
- **Reusable Components**: Define widgets once, use everywhere
- **Type Safety**: Catch errors at compile time
- **Version Control**: Track source files, not 30KB JSON blobs
- **Maintainability**: Change metric prefix in one place, regenerate all dashboards
- **Documentation**: Self-documenting through clear structure

**Example**: Changing all GitHub metric sources from `source:softmax-system-health` to `source:github-collector`:
- **Jsonnet**: Change 1 line in `components/ci.libsonnet`, rebuild
- **Hand-crafted JSON**: Edit 15KB across multiple files

---

## Troubleshooting

### Q: My JSON file isn't being committed to git

**A**: This is expected! JSON files in `templates/` are gitignored as build artifacts. The `.jsonnet` source files in `dashboards/` are the source of truth.

**Exception**: Python-generated dashboards may be tracked temporarily until we decide on the workflow.

### Q: How do I update a dashboard?

**A**:
1. Edit the `.jsonnet` source file in `dashboards/sources/`
2. Rebuild: `jsonnet dashboards/sources/my_dashboard.jsonnet > dashboards/templates/my_dashboard.json`
3. Push: `python scripts/push_dashboard.py dashboards/templates/my_dashboard.json`

### Q: I created a dashboard in Datadog UI, how do I version control it?

**A**:
1. Export: `python scripts/export_dashboard.py <dashboard-id> > dashboards/templates/temp.json`
2. Convert to Jsonnet: Copy widget structures to a new `.jsonnet` file
3. Test: Build and compare with original
4. Push: Deploy the jsonnet-generated version
5. Clean up: Delete `temp.json`

---

## References

- **Jsonnet Tutorial**: https://jsonnet.org/learning/tutorial.html
- **Datadog Dashboard JSON API**: https://docs.datadoghq.com/dashboards/graphing_json/
- **Component Libraries**: See `dashboards/components/*.libsonnet` for examples
- **WORKPLAN**: `../WORKPLAN.md` for Jsonnet system design decisions
