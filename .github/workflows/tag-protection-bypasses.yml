name: Tag Protection Bypasses

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to check"
        required: true
        type: number
      merge_sha:
        description: "Merge commit SHA to tag"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: read
  administration: read

jobs:
  tag-if-bypassed:
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Check if protections were bypassed
        run: |
          # Use manual inputs or PR event data
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER=${{ inputs.pr_number }}
            MERGE_SHA=${{ inputs.merge_sha }}
          else
            PR_NUMBER=${{ github.event.pull_request.number }}
            MERGE_SHA=${{ github.event.pull_request.merge_commit_sha }}
          fi

          echo "Checking PR #$PR_NUMBER (SHA: $MERGE_SHA)"

          # Check reviews
          REQUIRED_REVIEWS=$(gh api repos/${{ github.repository }}/branches/main/protection --jq '.required_pull_request_reviews.required_approving_review_count // 0')
          ACTUAL_REVIEWS=$(gh pr view $PR_NUMBER --json reviews --jq '[.reviews[] | select(.state == "APPROVED")] | length')

          # Check status checks
          REQUIRED_CHECKS=$(gh api repos/${{ github.repository }}/branches/main/protection --jq '.required_status_checks.contexts // [] | length')
          PASSED_CHECKS=$(gh pr view $PR_NUMBER --json statusCheckRollup --jq '[.statusCheckRollup[] | select(.conclusion == "SUCCESS")] | length')

          echo "Required reviews: $REQUIRED_REVIEWS, Actual: $ACTUAL_REVIEWS"
          echo "Required checks: $REQUIRED_CHECKS, Passed: $PASSED_CHECKS"

          # Tag if bypassed
          if [ "$ACTUAL_REVIEWS" -lt "$REQUIRED_REVIEWS" ] || [ "$PASSED_CHECKS" -lt "$REQUIRED_CHECKS" ]; then
            TIMESTAMP=$(date +%s)
            TAG_NAME="forced-${TIMESTAMP}"
            git tag -a "$TAG_NAME" $MERGE_SHA -m "Protection bypassed on PR #$PR_NUMBER"
            git push origin "$TAG_NAME"
            echo "Tagged: Protection bypass detected"
          else
            echo "No bypass detected"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
