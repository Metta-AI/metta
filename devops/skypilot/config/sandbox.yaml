resources:
  cloud: aws
  region: us-east-1
  accelerators: "L4:1"
  cpus: 8+
  image_id: docker:metta:latest

file_mounts:
  /mnt/s3/softmax-public:
    source: s3://softmax-public
    mode: MOUNT_CACHED

  /mnt/s3/train_dir:
    source: s3://softmax-train-dir
    mode: MOUNT_CACHED

setup: |
  set -e
  cd /workspace/metta

  git fetch origin "$METTA_GIT_REF" || git fetch --depth=1000 origin
  git checkout "$METTA_GIT_REF"
  echo "[SETUP] Checked out: $(git rev-parse HEAD)"

  # Python environment setup
  echo "[SETUP] Setting up Python environment..."
  uv sync

  # Create required directories
  mkdir -p $WANDB_DIR

  # Note that different sets of skypilot environment variables are available in "run" vs "setup"
  # see https://docs.skypilot.co/en/latest/running-jobs/environment-variables.html

  echo 'cd /workspace/metta' >> ~/.bashrc
  echo '. .venv/bin/activate' >> ~/.bashrc
  echo '. devops/setup.env' >> ~/.bashrc

  echo "[SETUP] Creating job secrets..."
  ./devops/skypilot/create_job_secrets.py \
    --wandb-password "$WANDB_PASSWORD" \
    --observatory-token "$OBSERVATORY_TOKEN"

  echo "[SETUP] Sandbox is ready"

run: |
  set -e
  cd /workspace/metta

  # Note that the docker image may start with its own venv - switch to metta venv
  if [ -n "$VIRTUAL_ENV" ]; then
      deactivate 2>/dev/null || true
  fi
  . .venv/bin/activate

  # set up GPU-related environment variables
  export NUM_GPUS=${SKYPILOT_NUM_GPUS_PER_NODE}
  export NUM_NODES=${SKYPILOT_NUM_NODES}
  export MASTER_ADDR=$(echo "${SKYPILOT_NODE_IPS}" | head -n1)
  export MASTER_PORT=8008
  export NODE_INDEX=${SKYPILOT_NODE_RANK}
  export NCCL_SHM_DISABLE=1

  echo "[RUN] Creating job secrets..."
  ./devops/skypilot/create_job_secrets.py \
    --wandb-password "$WANDB_PASSWORD" \
    --observatory-token "$OBSERVATORY_TOKEN"

  echo "Starting bash shell..."
  exec bash

envs:
  METTA_GIT_REF: main
  WANDB_DIR: ./wandb

  # username and password are acquired automatically by our skypilot-api-server patch, see skypilot-chart/files/ecr.patch
  SKYPILOT_DOCKER_USERNAME: ""
  SKYPILOT_DOCKER_PASSWORD: ""
  SKYPILOT_DOCKER_SERVER: 751442549699.dkr.ecr.us-east-1.amazonaws.com

secrets:
  # configured by launch script based on local credentials
  WANDB_PASSWORD: ""
  OBSERVATORY_TOKEN: ""
