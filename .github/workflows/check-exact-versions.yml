name: Check Exact Versions

on:
  pull_request:
    paths:
      - "**/pyproject.toml"
      - ".github/scripts/check_exact_versions.py"
      - ".github/workflows/check-exact-versions.yml"
  push:
    branches: [main]
    paths:
      - "**/pyproject.toml"
      - ".github/scripts/check_exact_versions.py"

jobs:
  check-build-dependencies:
    name: Check Build System Dependencies Use Exact Versions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        uses: ./.github/actions/setup-environment

      - name: Check for exact version specifiers
        run: |
          echo "🔍 Checking that all [build-system] requires use exact versions..."
          uv run .github/scripts/check_exact_versions.py

      - name: Generate report on failure
        if: failure()
        run: |
          echo "## Build System Dependency Version Check Failed" > version_check_report.md
          echo "" >> version_check_report.md
          echo "Some pyproject.toml files have [build-system] requires that don't use exact versions." >> version_check_report.md
          echo "" >> version_check_report.md
          echo "**Required format:** All dependencies in \`[build-system]\` requires must use exact version syntax (\`==\`)." >> version_check_report.md
          echo "" >> version_check_report.md
          echo "**Example:**" >> version_check_report.md
          echo '```toml' >> version_check_report.md
          echo '[build-system]' >> version_check_report.md
          echo 'requires = ["setuptools==80.9.0", "wheel==0.45.1"]' >> version_check_report.md
          echo '```' >> version_check_report.md
          echo "" >> version_check_report.md
          echo "**Rationale:** Exact versions ensure reproducible builds and prevent unexpected breakage from dependency updates." >> version_check_report.md
          echo "" >> version_check_report.md
          echo "See PR #3352 for more information." >> version_check_report.md

          cat version_check_report.md

      - name: Upload report on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: version-check-report
          path: version_check_report.md
          retention-days: 30
