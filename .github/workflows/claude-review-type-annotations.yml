name: "Claude Review: Types"
on:
  pull_request:
    types: [opened, reopened]
    paths: ["**/*.py"]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request number to review'
        required: true
        type: string

jobs:
  review:
    uses: ./.github/workflows/claude-review-base.yml
    with:
      review_name: "Type Annotations"
      file_pattern: "\.py$"
      setup_python: true
      install_packages: "mypy"
      tools: "Edit,Replace,Bash(git diff HEAD~1),Bash(python -m mypy --version)"
      pr_number: ${{ inputs.pr_number || '' }}
      prompt: |
        Please review the Python code in this PR for type annotation improvements that would enhance code readability and IDE support. Our philosophy is that type annotations should make code easier to understand and refactor, not harder.

        **IMPORTANT**: Only create a PR comment if you find type annotation improvements worth suggesting. If the code already has good type coverage or doesn't need additional annotations, do not comment at all.

        **Core Principle:** Only suggest type annotations that provide real value. When in doubt, trust type inference.

        **1. Function Parameters - Always annotate these:**
        - All function parameters should have type annotations
        - This is the highest value place for annotations
        - Helps both IDE tools and developers understand expected inputs

        **2. Function Return Types - Be selective:**
        **DO annotate return types for:**
        - Public API functions/methods (anything not prefixed with _)
        - Functions with complex logic or multiple branches where return type serves as an assertion
        - Functions where the return type isn't obvious from the name
        - Functions that might return None in some cases

        **DON'T annotate return types for:**
        - Private methods internal to a class (easier refactoring)
        - Functions enclosed within other functions
        - Simple getters/setters where the type is obvious
        - Very short functions (1-3 lines) with obvious returns

        **3. Variable Assignments - Usually skip these:**
        - Rarely useful and often add noise
        - Only suggest when type inference has clearly failed
        - Or when initializing empty collections that will hold specific types
        - Trust the IDE's inference for most cases

        **4. Complex Data Structures:**
        - For complex dicts, consider suggesting refactoring to dataclasses instead of TypedDict
        - Dataclasses are often cleaner and more maintainable than heavily typed dicts
        - If you must type a dict, only do so when the structure is truly complex and reused

        **5. Modern Typing Syntax:**
        - Use `list[str]` instead of `List[str]` for Python 3.9+
        - Use `type | None` instead of `Optional[type]` for Python 3.10+
        - This is minor but good for consistency

        **Review Process:**
        1. First scan for missing parameter annotations (highest priority)
        2. Then look at public function return types
        3. Check for complex/branching functions that would benefit from return type assertions
        4. Only suggest variable annotations when absolutely necessary
        5. For complex dicts, consider suggesting dataclass refactoring

        **What NOT to do:**
        - Don't annotate obvious variable assignments
        - Don't annotate private method returns unless there's a specific benefit
        - Don't add annotations just because you can
        - Don't suggest TypedDict for simple structures (prefer dataclasses)

        **Creating suggestions:**
        - Explain WHY each annotation improves the code
        - For return types, mention if it's for API clarity or as a safety assertion
        - If you see complex dict structures, suggest considering dataclasses as an alternative

        Remember: The goal is to make code easier to understand and refactor, not to achieve 100% annotation coverage. Good type hints guide developers and catch bugs without getting in the way.

        **TLDR Section:**
        If you do make suggestions, conclude with a brief summary organized by value:
        - **Must fix:** Missing parameter annotations
        - **Recommended:** Public API return types, complex function returns
        - **Consider:** Dataclass refactoring for complex dicts
        - **Optional:** Other minor improvements

        Keep the TLDR concise with file names and line numbers.
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
