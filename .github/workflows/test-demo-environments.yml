name: Test Demo Environments

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'mettagrid/demos/**'
      - 'mettagrid/src/**'
      - 'mettagrid/pyproject.toml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'mettagrid/demos/**'
      - 'mettagrid/src/**'
      - 'mettagrid/pyproject.toml'
  workflow_dispatch:

jobs:
  test-demos:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "0.7.3"
        enable-cache: false
    
    - name: Create virtual environment
      run: |
        uv venv
        echo "VIRTUAL_ENV=$(pwd)/.venv" >> $GITHUB_ENV
        echo "$(pwd)/.venv/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      run: |
        echo "Installing metta-mettagrid..."
        uv pip install --no-build-isolation --no-deps -e ./mettagrid
        echo "Installing metta-common..."
        uv pip install --no-deps -e ./common
        echo "Verifying installations..."
        uv pip list | grep -E "(metta-mettagrid|metta-common)"
    
    - name: Check demo scripts format
      run: |
        cd mettagrid/demos
        echo "Checking demo scripts exist and have correct format..."
        for demo in gym_demo.py pettingzoo_demo.py puffer_demo.py test_demos.py; do
          if [ -f "$demo" ]; then
            echo "✅ $demo exists"
          else
            echo "❌ $demo not found"
            exit 1
          fi
          
          if head -n 1 "$demo" | grep -q "#!/usr/bin/env python"; then
            echo "✅ $demo has correct Python shebang"
          else
            echo "❌ $demo missing Python shebang"
            exit 1
          fi
          
          if head -n 10 "$demo" | grep -q "# /// script"; then
            echo "✅ $demo has PEP 723 metadata"
          else
            echo "❌ $demo missing PEP 723 metadata"
            exit 1
          fi
        done
    
    - name: Test individual demos
      run: |
        cd mettagrid/demos
        echo "Testing individual demos..."
        for demo in gym_demo.py pettingzoo_demo.py puffer_demo.py; do
          echo "Testing $demo..."
          timeout 120 uv run python $demo || exit_code=$?
          if [ $exit_code -eq 124 ]; then
            echo "✅ $demo ran successfully for 120 seconds"
          elif [ $exit_code -eq 0 ]; then
            echo "✅ $demo completed successfully"
          else
            echo "❌ $demo failed with exit code $exit_code"
            exit 1
          fi
        done
    
    - name: Test with comprehensive test script
      run: |
        cd mettagrid/demos
        echo "Running comprehensive test script..."
        uv run python test_demos.py