name: Build mettascope (nim)

on:
  pull_request:
    paths:
      - "mettascope2/**"
      - ".github/workflows/build-mettascope2.yml"
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache nimble
        id: cache-nimble
        uses: actions/cache@v4
        with:
          path: ~/.nimble
          key: ${{ runner.os }}-nimble-${{ hashFiles('mettascope2/mettascope2.nimble') }}
          restore-keys: |
            ${{ runner.os }}-nimble-
      - uses: jiro4989/setup-nim-action@v2
        with:
          # repo-token is used for rate limiting.
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - run: cd mettascope2 && nimble install -y

      - name: Build mettascope2 (release)
        run: cd mettascope2 && nim c -d:release --out:src/mettascope.out src/mettascope.nim

      - name: Upload mettascope2 artifact
        uses: actions/upload-artifact@v4
        with:
          name: mettascope.out
          path: |
            mettascope2/src/mettascope.out
            mettascope2/data/
          if-no-files-found: error


