version: '3.8'
services:
  eval-worker:
    build:
      context: ../../../../
      dockerfile: devops/docker/Dockerfile
      platforms:
        - "linux/amd64"  # Force build for x86_64
    platform: linux/amd64  # Force runtime platform
    image: metta/eval-worker:latest
    command: echo "Image built successfully"

  eval-worker-orchestrator:
    depends_on:
      - eval-worker
    image: metta/eval-worker:latest
    platform: linux/amd64  # Force runtime platform
    environment:
      - BACKEND_URL=${BACKEND_URL:-http://host.docker.internal:8000}
      - WORKER_IDLE_TIMEOUT=${WORKER_IDLE_TIMEOUT:-600}
      - PYTHONPATH=/workspace/metta
      - TRAIN_DIR_HOST_PATH=/Users/nishadsingh/repos/metta2/train_dir
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ../../../../train_dir:/workspace/train_dir
    command: [ "uv", "run", "python", "-m", "metta.app_backend.eval_task_orchestrator" ]
    network_mode: "host"
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
