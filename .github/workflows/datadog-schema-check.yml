name: "Datadog Schema Validation"

on:
  pull_request:
    paths:
      - "devops/datadog/**"
      - ".github/workflows/datadog-schema-check.yml"
  push:
    branches:
      - main
    paths:
      - "devops/datadog/**"
      - ".github/workflows/datadog-schema-check.yml"
  workflow_dispatch:

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv pip install --system \
            boto3 \
            kubernetes \
            pandas \
            pyarrow \
            typer \
            datadog-api-client \
            requests \
            pydantic \
            pydantic-settings

      - name: Install workspace packages
        run: |
          uv pip install --system -e ./softmax -e ./common || true

      - name: Validate schema and generate dashboards
        env:
          PYTHONPATH: "${{ github.workspace }}:${{ github.workspace }}/softmax/src:${{ github.workspace }}/common/src"
        run: |
          # This will fail if:
          # - Any metric in schema is missing from collector sources
          # - Dashboard generation fails
          # - Schema validation fails
          python -m devops.datadog.generate_dashboards

      - name: Verify dashboard JSON is valid
        run: |
          python -c "
          import json
          import sys
          from pathlib import Path

          summary_path = Path('devops/datadog/dashboards/infra_summary.json')
          detailed_path = Path('devops/datadog/dashboards/infra_detailed.json')

          for path in [summary_path, detailed_path]:
              if not path.exists():
                  print(f'ERROR: Dashboard file {path} does not exist')
                  sys.exit(1)
              try:
                  with open(path) as f:
                      json.load(f)
                  print(f'✓ {path.name} is valid JSON')
              except json.JSONDecodeError as e:
                  print(f'ERROR: {path.name} is invalid JSON: {e}')
                  sys.exit(1)
          print('✓ All dashboard files are valid JSON')
          "
