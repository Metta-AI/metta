name: Cleanup Cancelled Runs

# Triggers after the main "Test and Benchmark" workflow completes
# This approach prevents the cleanup job from being cancelled by concurrency settings
on:
  workflow_run:
    workflows: ["Test and Benchmark"]
    types: [completed]
    branches:
      - main

# Explicit concurrency settings to prevent cancellation
# Each cleanup run gets a unique group based on the triggering workflow run ID
# cancel-in-progress: false ensures this workflow never gets cancelled
concurrency:
  group: cleanup-cancelled-runs-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

permissions:
  actions: write
  contents: read

jobs:
  cleanup-cancelled-runs:
    name: "Cleanup Cancelled Runs"
    # Only run on push events to main (typically merge commits)
    # This ensures we clean up cancelled runs after merges to main
    if: |
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main' &&
      (contains(github.event.workflow_run.head_commit.message, 'Merge pull request') ||
       contains(github.event.workflow_run.head_commit.message, 'Merge branch'))
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      deleted-count: ${{ steps.cleanup.outputs.deleted-count }}
      status: ${{ steps.cleanup.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cleanup cancelled runs from concurrency
        id: cleanup
        continue-on-error: true
        uses: ./.github/actions/cleanup-cancelled-runs
        with:
          workflow-file: "checks.yml"
          max-deletions: "10"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Report cleanup status
        if: always()
        run: |
          if [ "${{ steps.cleanup.outcome }}" == "success" ]; then
            echo "✅ Cleanup completed successfully"
            echo "Deleted runs: ${{ steps.cleanup.outputs.deleted-count || '0' }}"
          else
            echo "⚠️ Cleanup job completed with status: ${{ steps.cleanup.outcome }}"
            echo "This is non-blocking - workflow will continue"
          fi
