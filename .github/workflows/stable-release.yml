name: "Daily Stable Release"

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      version:
        description: "Optional: Version number (overrides auto-continue behavior)"
        required: false
        type: string
      skip_commit_match:
        description: "Skip verification that current commit matches RC tag"
        required: false
        type: boolean
        default: false

jobs:
  stable-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to create tags and push to stable branch
      issues: write # Needed for Asana integration (if used)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for git operations

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          install-mode: runtime

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Weights & Biases credentials
        run: |
          echo "machine api.wandb.ai" > $HOME/.netrc
          echo "login user" >> $HOME/.netrc
          echo "password ${{ secrets.WANDB_API_KEY }}" >> $HOME/.netrc
          chmod 600 $HOME/.netrc
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}

      - name: Set up Observatory credentials
        run: |
          mkdir -p $HOME/.metta
          echo "${{ secrets.OBSERVATORY_TOKEN }}" > $HOME/.metta/observatory_token

      - name: Configure SkyPilot API server
        run: |
          sky api login -e https://skypilot-api.softmax-research.net --token ${{ secrets.SKYPILOT_SERVICE_ACCOUNT_TOKEN }}

      - name: Run stable release process
        id: release
        run: |
          # Build command with optional arguments
          CMD="./devops/stable/stable.py --no-interactive release"

          if [ -n "${{ github.event.inputs.version }}" ]; then
            CMD="$CMD --version=${{ github.event.inputs.version }}"
          fi

          if [ "${{ github.event.inputs.skip_commit_match }}" == "true" ]; then
            CMD="$CMD --skip-commit-match"
          fi

          echo "Running: $CMD"
          $CMD
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          OBSERVATORY_TOKEN: ${{ secrets.OBSERVATORY_TOKEN }}
          SKYPILOT_SERVICE_ACCOUNT_TOKEN: ${{ secrets.SKYPILOT_SERVICE_ACCOUNT_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Discord notification on success
        if: success()
        uses: ./.github/actions/discord-webhook
        with:
          webhook-url: ${{ secrets.DISCORD_STABLE_HOOK }}
          content: |
            ✅ **Stable Release Completed**

            Daily stable release process completed successfully.

            Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send Discord notification on failure
        if: failure()
        uses: ./.github/actions/discord-webhook
        with:
          webhook-url: ${{ secrets.DISCORD_STABLE_HOOK }}
          content: |
            ❌ **Stable Release Failed**

            Daily stable release process failed. Check workflow logs for details.

            Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Upload release artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-logs
          path: |
            devops/stable/state/*.log
            devops/stable/state/*.json
            devops/stable/release-notes/*.md
          retention-days: 30
