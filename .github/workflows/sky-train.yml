name: "Launch SkyPilot Training Job"

on:
  workflow_dispatch:
    inputs:
      timeout_hours:
        description: "Job timeout in hours (auto-termination)"
        required: true
        default: 1
        type: number
      trainer_env:
        description: "Training environment configuration"
        required: true
        default: "env/mettagrid/arena/advanced"
        type: string
      commit_to_run:
        description: "The full commit hash to run the job against (required for manual runs)."
        required: true
        type: string
      pr_number:
        description: "PR number (for naming/context if running a PR's commit, leave empty otherwise)"
        required: false
        type: string
      num_gpus:
        description: "Number of GPUs to request (e.g., 1, 4). If empty, defaults to SkyPilot task definition (usually 1)."
        required: false
        type: string # Keep as string to allow empty, action handles default
      num_nodes:
        description: "Number of Nodes to request (e.g., 1, 2). If empty, defaults to SkyPilot task definition (usually 1)."
        required: false
        type: string # Keep as string to allow empty, action handles default
  push:
    branches: [main]

env:
  DEFAULT_TRAINER_ENV: "env/mettagrid/arena/advanced"
  DEFAULT_TIMEOUT_HOURS: 0.167 # 10 minutes = 0.167 hours
  DEFAULT_NUM_GPUS: "2"
  DEFAULT_NUM_NODES: "2"
  RUN_NAME_PREFIX: "github.sky"

jobs:
  launch-batch-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout specific commit for dispatch
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.commit_to_run }}
          fetch-depth: 1

      - name: Checkout full history for push
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Determine PR Number for Push Events
        id: pr_info
        if: github.event_name == 'push'
        shell: bash
        run: |
          PR_FROM_COMMIT=$(git log -1 --pretty=format:"%s" | sed -n 's/.*(#\\([0-9][0-9]*\\)).*/\\1/p')
          echo "Extracted PR number from commit message (if any): $PR_FROM_COMMIT"
          echo "pr_number_for_name_generation=${PR_FROM_COMMIT}" >> $GITHUB_OUTPUT

      - name: Generate Run Name
        id: generate_run_name
        shell: bash
        run: |
          set -eo pipefail
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          # SHORT_COMMIT_HASH is derived from the actual checked-out HEAD.
          # This HEAD is set by the conditional 'Checkout code' steps:
          # - For 'push', it's the trigger commit.
          # - For 'workflow_dispatch', it's github.event.inputs.commit_to_run.
          SHORT_COMMIT_HASH=$(git rev-parse --short HEAD)

          # Extract trainer env suffix (everything after env/mettagrid)
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TRAINER_ENV="${{ github.event.inputs.trainer_env }}"
          else
            TRAINER_ENV="${{ env.DEFAULT_TRAINER_ENV }}"
          fi

          # Extract everything after "env/mettagrid/" and replace slashes with dots
          # e.g., "env/mettagrid/arena/advanced" -> "arena.advanced"
          # e.g., "env/mettagrid/a/b/c" -> "a.b.c"
          TRAINER_ENV_SUFFIX=$(echo "$TRAINER_ENV" | sed 's|^env/mettagrid/||' | sed 's|/|.|g')

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual dispatch: run name is github.sky.<short_hash>.<trainer_env_suffix>.<timestamp>
            # The github.event.inputs.pr_number is not used for the run name itself here.
            if [ -z "${{ github.event.inputs.commit_to_run }}" ]; then
              echo "Error: commit_to_run is required for workflow_dispatch and was not provided."
              exit 1
            fi
            # Sanity check that checked-out commit matches the input
            INPUT_SHORT_HASH=$(echo "${{ github.event.inputs.commit_to_run }}" | cut -c1-7)
            if [ "$SHORT_COMMIT_HASH" != "$INPUT_SHORT_HASH" ]; then
                echo "Warning: Checked out HEAD's short hash ($SHORT_COMMIT_HASH) does not match input commit_to_run's short hash ($INPUT_SHORT_HASH). Using checked out HEAD."
            fi
            RUN_NAME_BASE="${{ env.RUN_NAME_PREFIX }}"
            FINAL_RUN_NAME="$RUN_NAME_BASE.$SHORT_COMMIT_HASH.$TRAINER_ENV_SUFFIX.$TIMESTAMP"
            echo "Manual dispatch: Using commit ($SHORT_COMMIT_HASH). Run name: $FINAL_RUN_NAME"

          elif [ "${{ github.event_name }}" == "push" ]; then
            # Push event: run name includes PR number (if found) or branch name.
            PR_NUMBER_FROM_COMMIT="${{ steps.pr_info.outputs.pr_number_for_name_generation || '' }}"

            if [ -n "$PR_NUMBER_FROM_COMMIT" ]; then
              RUN_NAME_BASE="${{ env.RUN_NAME_PREFIX }}.pr${PR_NUMBER_FROM_COMMIT}"
              echo "Push event: Using PR #$PR_NUMBER_FROM_COMMIT in run name base: $RUN_NAME_BASE"
            else
              BRANCH_NAME_RAW=$(git rev-parse --abbrev-ref HEAD)
              BRANCH_NAME_SANITIZED=$(echo "$BRANCH_NAME_RAW" | sed 's/[^a-zA-Z0-9_-]/-/g')
              RUN_NAME_BASE="${{ env.RUN_NAME_PREFIX }}.${BRANCH_NAME_SANITIZED}"
              echo "Push event: Using branch name '$BRANCH_NAME_SANITIZED' in run name base: $RUN_NAME_BASE (PR number not found in commit)"
            fi
            FINAL_RUN_NAME="$RUN_NAME_BASE.$SHORT_COMMIT_HASH.$TRAINER_ENV_SUFFIX.$TIMESTAMP"
            echo "Push event: Run name: $FINAL_RUN_NAME"
          else
            echo "Error: Unhandled event type ${{ github.event_name }}"
            exit 1
          fi

          echo "Generated run name for SkyPilot: $FINAL_RUN_NAME"
          echo "Trainer environment suffix: $TRAINER_ENV_SUFFIX"
          echo "run_name=$FINAL_RUN_NAME" >> $GITHUB_OUTPUT

      - name: Launch SkyPilot Job via Custom Action
        id: skylaunch
        uses: ./.github/actions/launch-skypilot-job
        with:
          trainer_env: ${{ github.event.inputs.trainer_env || env.DEFAULT_TRAINER_ENV }}
          timeout_hours: ${{ github.event_name == 'push' && env.DEFAULT_TIMEOUT_HOURS || github.event.inputs.timeout_hours || env.DEFAULT_TIMEOUT_HOURS }}
          num_gpus: ${{ github.event_name == 'push' && env.DEFAULT_NUM_GPUS || github.event.inputs.num_gpus || '' }}
          num_nodes: ${{ github.event_name == 'push' && env.DEFAULT_NUM_NODES || github.event.inputs.num_nodes || '' }}
          run_name: ${{ steps.generate_run_name.outputs.run_name }} # Pass the fully generated name
          wandb_api_key: ${{ secrets.WANDB_API_KEY }}
          skypilot_service_account_token: ${{ secrets.SKYPILOT_SERVICE_ACCOUNT_TOKEN }}
          observatory_token: ${{ secrets.OBSERVATORY_TOKEN }}
          commit_sha: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.commit_to_run || github.sha }}
          github_pat: ${{ secrets.METTA_STATUS_PAT }} # expires August 2026

      - name: Print Run Information
        shell: bash
        run: |
          echo "Workflow triggered by: ${{ github.event_name }}"
          echo "SkyPilot Job Name / W&B Run Name: ${{ steps.generate_run_name.outputs.run_name }}"
          echo "SkyPilot Task Name: ${{ steps.generate_run_name.outputs.run_name }}"
          echo "To see logs for this job in SkyPilot, you might use: sky jobs logs ${{ steps.generate_run_name.outputs.run_name }} (if job was successfully submitted)"
