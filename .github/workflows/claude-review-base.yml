name: Claude Review Base
on:
  workflow_call:
    inputs:
      review_name:
        required: true
        type: string
      file_pattern:
        required: false
        type: string
        default: ".*"
      setup_python:
        required: false
        type: boolean
        default: false
      install_packages:
        required: false
        type: string
        default: ""
      tools:
        required: true
        type: string
      prompt:
        required: true
        type: string
      pr_number:
        required: false
        type: string
        default: ""
    secrets:
      anthropic_api_key:
        required: true

env:
  CLAUDE_MODEL: "claude-opus-4-20250514"

  # Updated prompt that tells Claude to only create JSON if there are issues
  UNIVERSAL_PROMPT_PREFIX: |
    ## GitHub PR Review Instructions - Conditional JSON Output

    You are reviewing a GitHub Pull Request. Your primary goal is to find issues that need to be addressed.

    **CRITICAL INSTRUCTIONS:**
    1. First, analyze the code according to the specific review focus
    2. If you find NO issues, suggestions, or required changes:
       - Simply respond with "No issues found."
       - DO NOT create any JSON file
       - DO NOT use the Write tool
    3. ONLY if you find issues that need to be addressed:
       - Use the Write tool to save your analysis to 'claude-review-analysis.json'
       - Include suggestions for improvements

    When creating JSON (only if issues are found), use this structure:
    {
      "review_summary": "Brief overall assessment of the PR",
      "review_status": "COMMENT|CHANGES_REQUESTED",  // Never use APPROVE
      "suggestions": [
        {
          "file": "path/to/file.py",
          "start_line": 23,
          "end_line": 24,
          "side": "RIGHT",
          "severity": "minor|major|blocking|nitpick",
          "reason": "Brief explanation of why this change improves the code",
          "original_code": "exact code from file including any comments",
          "suggested_code": "replacement code"
        }
      ],
      "compliments": [
        {
          "file": "path/to/file.py",
          "line": 45,
          "comment": "Positive feedback about good code"
        }
      ],
      "tldr": [
        "file.py:23-24 - Remove redundant comment",
        "README.md:12 - Update installation command"
      ]
    }

    Remember:
    - Only create the JSON file if you have actual suggestions
    - Never use review_status: "APPROVE" - if there are no issues, don't create a file
    - Focus on finding genuine improvements, not nitpicks

    ---
    Now, here are your specific review instructions:

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize Review Summary
        run: |
          echo "# ðŸ¤– Claude Review: ${{ inputs.review_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** ${{ env.CLAUDE_MODEL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Setup PR Context
        id: pr-context
        run: |
          # Determine PR number and checkout if needed
          if [ -n "${{ inputs.pr_number }}" ]; then
            PR_NUMBER="${{ inputs.pr_number }}"
            gh pr checkout $PR_NUMBER
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          else
            echo "No PR context available"
            exit 1
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # Get base ref for diff
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="${{ github.base_ref }}"
          else
            PR_INFO=$(gh pr view $PR_NUMBER --json baseRefName,title,author)
            BASE_REF=$(echo "$PR_INFO" | jq -r '.baseRefName')
            PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
            PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.author.login')

            echo "## PR Information" >> $GITHUB_STEP_SUMMARY
            echo "- **PR #$PR_NUMBER:** $PR_TITLE" >> $GITHUB_STEP_SUMMARY
            echo "- **Author:** @$PR_AUTHOR" >> $GITHUB_STEP_SUMMARY
            echo "- **Base branch:** $BASE_REF" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check File Changes
        id: check-files
        run: |
          BASE_REF="${{ steps.pr-context.outputs.base_ref }}"
          PATTERN="${{ inputs.file_pattern }}"

          # Get all changed files
          ALL_FILES=$(git diff --name-only origin/$BASE_REF HEAD || echo "")
          TOTAL_CHANGED=$(echo "$ALL_FILES" | grep -v '^$' | wc -l || echo 0)

          # Filter by pattern if provided
          if [ "$PATTERN" != ".*" ]; then
            MATCHED_FILES=$(echo "$ALL_FILES" | grep -E "$PATTERN" || echo "")
          else
            MATCHED_FILES="$ALL_FILES"
          fi

          MATCHED_COUNT=$(echo "$MATCHED_FILES" | grep -v '^$' | wc -l || echo 0)

          echo "## File Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Total files changed:** $TOTAL_CHANGED" >> $GITHUB_STEP_SUMMARY
          echo "- **Pattern:** \`$PATTERN\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Files matching pattern:** $MATCHED_COUNT" >> $GITHUB_STEP_SUMMARY

          if [ -n "$MATCHED_FILES" ] && [ "$MATCHED_COUNT" -le 20 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Files to review</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$MATCHED_FILES" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$MATCHED_FILES" ]; then
            echo "has_relevant_changes=true" >> $GITHUB_OUTPUT
            echo "matched_count=$MATCHED_COUNT" >> $GITHUB_OUTPUT
          else
            echo "has_relevant_changes=false" >> $GITHUB_OUTPUT
            echo "matched_count=0" >> $GITHUB_OUTPUT
            echo "**Result:** â­ï¸ No relevant files to review" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Setup Python
        if: steps.check-files.outputs.has_relevant_changes == 'true' && inputs.setup_python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Dependencies
        if: steps.check-files.outputs.has_relevant_changes == 'true' && inputs.install_packages != ''
        run: |
          echo "## Setup" >> $GITHUB_STEP_SUMMARY
          echo "- **Python:** $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **Installing:** ${{ inputs.install_packages }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          pip install ${{ inputs.install_packages }}

      # Stage 1: Run Claude Analysis
      - name: "Stage 1: Claude Analysis"
        id: claude-analysis
        if: steps.check-files.outputs.has_relevant_changes == 'true'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.anthropic_api_key }}
          anthropic_model: ${{ env.CLAUDE_MODEL }}
          allowed_tools: "${{ inputs.tools }},Write"
          direct_prompt: |
            ${{ env.UNIVERSAL_PROMPT_PREFIX }}

            ${{ inputs.prompt }}

            Remember: Only create the JSON file if you find actual issues to report.

      # Parse the JSON output (if it exists)
      - name: Parse Analysis Results
        id: parse-analysis
        if: steps.claude-analysis.outcome == 'success'
        run: |
          echo "=== PARSING ANALYSIS ==="

          # Check if Claude created the JSON file
          if [ -f "claude-review-analysis.json" ]; then
            echo "âœ… Found claude-review-analysis.json - Claude found issues to report"

            # Validate JSON
            if jq empty claude-review-analysis.json 2>/dev/null; then
              echo "âœ… Valid JSON"

              # Extract key information
              REVIEW_STATUS=$(jq -r '.review_status' claude-review-analysis.json)
              SUGGESTION_COUNT=$(jq '.suggestions | length' claude-review-analysis.json)
              HAS_SUGGESTIONS=$([ "$SUGGESTION_COUNT" -gt 0 ] && echo "true" || echo "false")

              echo "review_status=$REVIEW_STATUS" >> $GITHUB_OUTPUT
              echo "suggestion_count=$SUGGESTION_COUNT" >> $GITHUB_OUTPUT
              echo "has_suggestions=$HAS_SUGGESTIONS" >> $GITHUB_OUTPUT
              echo "found_issues=true" >> $GITHUB_OUTPUT

              echo "ðŸ“Š Review Status: $REVIEW_STATUS"
              echo "ðŸ’¡ Suggestions: $SUGGESTION_COUNT"
            else
              echo "âŒ Invalid JSON in claude-review-analysis.json"
              exit 1
            fi
          else
            echo "âœ… No claude-review-analysis.json found - Claude found no issues"
            echo "This is the expected behavior when there are no problems to report"
            echo "has_suggestions=false" >> $GITHUB_OUTPUT
            echo "suggestion_count=0" >> $GITHUB_OUTPUT
            echo "review_status=NONE" >> $GITHUB_OUTPUT
            echo "found_issues=false" >> $GITHUB_OUTPUT
          fi

          echo "========================"

      # Upload the JSON as an artifact for debugging (only if it exists)
      - name: Upload Analysis Artifact
        if: steps.parse-analysis.outcome == 'success' && steps.parse-analysis.outputs.found_issues == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: claude-review-${{ inputs.review_name }}-analysis
          path: claude-review-analysis.json
          retention-days: 7

      # Stage 2: Create GitHub Review (ONLY if issues were found)
      - name: "Stage 2: Create GitHub Review"
        id: create-review
        if: steps.parse-analysis.outputs.found_issues == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            console.log('=== CREATING GITHUB REVIEW ===');

            // Read the analysis
            const content = fs.readFileSync('claude-review-analysis.json', 'utf8');
            const analysis = JSON.parse(content);
            console.log(`ðŸ“‹ Loaded analysis with ${analysis.suggestions?.length || 0} suggestions`);

            // Get PR files
            console.log('Fetching PR files...');
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr-context.outputs.pr_number }}
            });
            console.log(`ðŸ“ Found ${files.length} files in PR`);

            // Build review comments array
            const comments = [];
            const skippedSuggestions = [];

            // Process suggestions
            for (const suggestion of (analysis.suggestions || [])) {
              const file = files.find(f => f.filename === suggestion.file);

              if (!file) {
                console.log(`âš ï¸  File ${suggestion.file} not found in PR`);
                skippedSuggestions.push(`${suggestion.file} - file not in PR diff`);
                continue;
              }

              console.log(`Processing suggestion for ${suggestion.file}:${suggestion.start_line}-${suggestion.end_line || suggestion.start_line}`);

              const comment = {
                path: suggestion.file,
                line: suggestion.end_line || suggestion.start_line,
                side: suggestion.side || 'RIGHT',
                body: [
                  `**${suggestion.severity || 'minor'}**: ${suggestion.reason}`,
                  '',
                  '```suggestion',
                  suggestion.suggested_code,
                  '```'
                ].join('\n')
              };

              // Add start_line for multi-line comments
              if (suggestion.start_line && suggestion.end_line && suggestion.start_line !== suggestion.end_line) {
                comment.start_line = suggestion.start_line;
                comment.start_side = suggestion.side || 'RIGHT';
              }

              comments.push(comment);
            }

            // Add compliments
            for (const compliment of (analysis.compliments || [])) {
              const file = files.find(f => f.filename === compliment.file);

              if (file) {
                console.log(`Adding compliment for ${compliment.file}:${compliment.line}`);
                comments.push({
                  path: compliment.file,
                  line: compliment.line,
                  side: 'RIGHT',
                  body: `âœ¨ ${compliment.comment}`
                });
              }
            }

            console.log(`ðŸ’¬ Prepared ${comments.length} review comments`);

            // Create review body
            const reviewName = '${{ inputs.review_name }}' || 'Code';
            const reviewBody = [
              `## ðŸ¤– Claude ${reviewName} Review`,
              '',
              analysis.review_summary || 'Review completed.',
              '',
              '### Summary',
              `- **Status**: ${(analysis.review_status || 'COMMENT').replace('_', ' ').toLowerCase()}`,
              `- **Suggestions**: ${analysis.suggestions?.length || 0}`,
              `- **Files reviewed**: ${files.length}`,
              '',
              ...(analysis.tldr?.length > 0 ? [
                '### Quick Summary',
                ...analysis.tldr.map(item => `- ${item}`),
                ''
              ] : []),
              ...(skippedSuggestions.length > 0 ? [
                '### âš ï¸ Skipped Suggestions',
                'The following suggestions could not be added as inline comments:',
                ...skippedSuggestions.map(s => `- ${s}`),
                ''
              ] : []),
              '---',
              comments.length > 0
                ? '*Review the inline comments above for specific suggestions. Each suggestion can be committed directly using GitHub\'s "Commit suggestion" button.*'
                : '*No specific code changes suggested in this review.*'
            ].join('\n');

            try {
              console.log('Creating PR review...');
              console.log(`Review type: ${analysis.review_status || 'COMMENT'}`);
              console.log(`Inline comments: ${comments.length}`);

              // Create the review
              const review = await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: ${{ steps.pr-context.outputs.pr_number }},
                body: reviewBody,
                event: analysis.review_status || 'COMMENT',
                comments: comments
              });

              console.log(`âœ… Created review #${review.data.id} with ${comments.length} inline comments`);

            } catch (error) {
              console.error('âŒ Failed to create review:', error.message);

              // Fallback: Create a simple comment
              console.log('Falling back to regular PR comment...');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.pr-context.outputs.pr_number }},
                body: reviewBody
              });
              console.log('âœ… Created fallback comment');
            }

      - name: Capture Review Results
        if: always()
        run: |
          echo "## Review Results" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-files.outputs.has_relevant_changes }}" != "true" ]; then
            echo "- **Status:** â­ï¸ Skipped (no matching files)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.claude-analysis.outcome }}" == "success" ]; then
            if [ "${{ steps.parse-analysis.outputs.found_issues }}" == "true" ]; then
              echo "- **Status:** âœ… Review completed with suggestions" >> $GITHUB_STEP_SUMMARY
              echo "- **Review decision:** ${{ steps.parse-analysis.outputs.review_status }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Files reviewed:** ${{ steps.check-files.outputs.matched_count }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Suggestions:** ${{ steps.parse-analysis.outputs.suggestion_count }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Review posted:** Check PR for inline suggestions" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Status:** âœ… Review completed - no issues found" >> $GITHUB_STEP_SUMMARY
              echo "- **Files reviewed:** ${{ steps.check-files.outputs.matched_count }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Result:** No changes needed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Status:** âŒ Review failed" >> $GITHUB_STEP_SUMMARY
            echo "- **Error:** Check logs for details" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*[View full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*" >> $GITHUB_STEP_SUMMARY
